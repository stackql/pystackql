name: 'Run Tests'
on:
  pull_request:
    branches:
      - main

jobs:
  run-tests:
    strategy:
      matrix:
        os:
          - ubuntu-latest
          - windows-latest
          - macos-latest
        python-version:
          - "3.8"
          - "3.9"
          - "3.10"
          - "3.11"
          - "3.12"
          - "3.13"
        exclude:
          - os: macos-latest
            python-version: "3.8"
          - os: macos-latest
            python-version: "3.13"            
    runs-on: ${{matrix.os}}
    name: 'Run Tests on ${{matrix.os}} with Python ${{matrix.python-version}}'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v5
        with:
          python-version: ${{ matrix.python-version }}

      - name: Upgrade pip
        shell: bash
        run: |
          python3 -m pip install --upgrade pip

      - name: Install pystackql with all dependencies
        run: |
          pip install -e .

      - name: Install test dependencies
        run: |
          pip install pytest>=6.2.5 pytest-cov>=2.12.0 nose>=1.3.7

      - name: Run non-server tests
        env:
          GITHUB_ACTIONS: 'true'
        run: |
          python3 run_tests.py
        shell: bash

      - name: Setup StackQL
        uses: stackql/setup-stackql@v2
        with:
          platform: ${{ matrix.os == 'windows-latest' && 'windows' || (matrix.os == 'macos-latest' && 'darwin' || 'linux') }}
      
      - name: Start StackQL server
        run: |
          sh start-stackql-server.sh
        shell: bash

      - name: Run server tests
        env:
          GITHUB_ACTIONS: 'true'
        run: |
          python3 run_server_tests.py
        shell: bash

      - name: Stop StackQL server
        run: |
          sh stop-stackql-server.sh
        shell: bash